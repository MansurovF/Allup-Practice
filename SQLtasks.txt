--Kitabxana database-i qurursunuz
Create database Library
use Library


--Books (Id, Name, PageCount)
--Books-un Name columu minimum 2 simvol maksimum 100 simvol deyer ala bileceyi serti olsun.
--Books-un PageCount columu minimum 10 deyerini ala bileceyi serti olsun.

Create table Books
(
Id int identity primary key,
Name nvarchar(100) Check (Len(Name)>=2),
PageCount int Check(PageCount >=10)
)
Insert into Books
Values
('Kecel qizin horukleri',230,1),
('kor essek qlazokdan baxir',110,2),
('Harry Potter',496,3),
('Manmud and Marriam',311,4),
('Pirattes',400,5)

--Authors (Id, Name, Surname)
Create table Authors
(
Id int identity primary key,
Name nvarchar(100),
Surname nvarchar(100)
)
 
('Jhonny','Star'),
('Greed','Cheferson')

--Books ve Authors table-larinizin mentiqi uygun elaqesi olsun.
Alter table Books
Add AuthorId int Foreign key references Authors(Id)

--Id, Name, PageCount ve AuthorFullName columnlarinin valuelarini qaytaran bir view yaradin
Create View usv_GetBooksWithAuthors
As
Select b.Id, b.Name, b.PageCount ,CONCAT(a.Name,' ',a.Surname)'AuthorFullName' from Books b
Join Authors a
On b.AuthorId =a .Id 

Select *From usv_GetBooksWithAuthors

--Gonderilmis axtaris deyirene gore hemin axtaris deyeri name ve ya authorFullNamelerinde olan Book-lari
--Id, Name, PageCount, AuthorFullName columnlari seklinde gostern procedure yazin

Create Procedure usp_BooksAuthors
@Search nvarchar(100)
as
begin
Select *From usv_GetBooksWithAuthors where Name like '%'+ @Search +'%' or AuthorFullName like '%'+@Search+'%'
End

exec usp_BooksAuthors 'arr'

--Authors tableinin insert, update ve deleti ucun (her biri ucun ayrica) procedure yaradin

Create Procedure usp_InsUpdateAut

@Name nvarchar(100),
@Surname nvarchar(100)
as
Begin
 insert into Authors(Name,Surname)
 Values
 (@name,@Surname)
End
exec usp_InsUpdateAut 'Nizami','Gencevi' 

Create Procedure usp_UAuto
@id int,
@name nvarchar(100),
@surname nvarchar(100)
as
begin
 Update Authors set Name=@name,Surname=@surname where id=@Id
end
exec usp_UAuto 6,'Tofiq','Memisov'

Create Procedure usp_DeletAut
@id int
as
begin
 Delete Authors Where id=@id
end
exec usp_DeletAut 6

--Authors-lari Id,FullName,BooksCount,MaxPageCount seklinde qaytaran view yaradirsiniz
--Id-author id-si, FullName - Name ve Surname birlesmesi,
--BooksCount - Hemin authorun elaqeli oldugu kitablarin sayi,
--MaxPageCount - hemin authorun elaqeli oldugu kitablarin icerisindeki max pagecount deyeri
Create view usv_EndofAu
as
Select a.Id,(a.Name+''+a.Surname)'Fullname',COUNT(*)'BooksCount',MAX(b.PageCount)'Maxcount' *from Authors a
Join Books b
On b.AuthorId =a.Id
Group By a.Id,a.Name,a.Surname 

Select * from usv_EndofAu
